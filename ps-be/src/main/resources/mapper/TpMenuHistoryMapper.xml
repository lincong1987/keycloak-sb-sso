<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiuxi.admin.core.mapper.TpMenuHistoryMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.jiuxi.admin.core.bean.entity.TpMenuHistory">
        <id column="HISTORY_ID" property="historyId" jdbcType="VARCHAR"/>
        <result column="MENU_ID" property="menuId" jdbcType="VARCHAR"/>
        <result column="MENU_NAME" property="menuName" jdbcType="VARCHAR"/>
        <result column="OPERATION_TYPE" property="operationType" jdbcType="VARCHAR"/>
        <result column="NODE_DATA_BEFORE" property="nodeDataBefore" jdbcType="LONGVARCHAR"/>
        <result column="NODE_DATA_AFTER" property="nodeDataAfter" jdbcType="LONGVARCHAR"/>
        <result column="FULL_TREE_BEFORE" property="fullTreeBefore" jdbcType="LONGVARCHAR"/>
        <result column="FULL_TREE_AFTER" property="fullTreeAfter" jdbcType="LONGVARCHAR"/>
        <result column="OPERATOR_ID" property="operatorId" jdbcType="VARCHAR"/>
        <result column="OPERATOR_NAME" property="operatorName" jdbcType="VARCHAR"/>
        <result column="OPERATION_TIME" property="operationTime" jdbcType="VARCHAR"/>
        <result column="CREATE_TIME" property="createTime" jdbcType="VARCHAR"/>
        <result column="CREATOR" property="creator" jdbcType="VARCHAR"/>
        <result column="UPDATE_TIME" property="updateTime" jdbcType="VARCHAR"/>
        <result column="UPDATOR" property="updator" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 基础列名 -->
    <sql id="Base_Column_List">
        HISTORY_ID, MENU_ID, MENU_NAME, OPERATION_TYPE, NODE_DATA_BEFORE, NODE_DATA_AFTER, 
        FULL_TREE_BEFORE, FULL_TREE_AFTER, OPERATOR_ID, OPERATOR_NAME, OPERATION_TIME, 
        CREATE_TIME, CREATOR, UPDATE_TIME, UPDATOR
    </sql>

    <!-- 插入菜单历史记录 -->
    <insert id="insert" parameterType="com.jiuxi.admin.core.bean.entity.TpMenuHistory">
        INSERT INTO tp_menu_history (
            HISTORY_ID, MENU_ID, MENU_NAME, OPERATION_TYPE, NODE_DATA_BEFORE, NODE_DATA_AFTER,
            FULL_TREE_BEFORE, FULL_TREE_AFTER, OPERATOR_ID, OPERATOR_NAME, OPERATION_TIME,
            CREATE_TIME, CREATOR, UPDATE_TIME, UPDATOR
        ) VALUES (
            #{historyId}, #{menuId}, #{menuName}, #{operationType}, #{nodeDataBefore}, #{nodeDataAfter},
            #{fullTreeBefore}, #{fullTreeAfter}, #{operatorId}, #{operatorName}, #{operationTime},
            #{createTime}, #{creator}, #{updateTime}, #{updator}
        )
    </insert>

    <!-- 根据菜单ID查询历史记录 -->
    <select id="selectByMenuId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        WHERE MENU_ID = #{menuId}
        ORDER BY OPERATION_TIME DESC
    </select>

    <!-- 根据操作人ID查询历史记录 -->
    <select id="selectByOperatorId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        WHERE OPERATOR_ID = #{operatorId}
        ORDER BY OPERATION_TIME DESC
    </select>

    <!-- 根据操作类型查询历史记录 -->
    <select id="selectByOperationType" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        WHERE OPERATION_TYPE = #{operationType}
        ORDER BY OPERATION_TIME DESC
    </select>

    <!-- 根据时间范围查询历史记录 -->
    <select id="selectByTimeRange" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        WHERE OPERATION_TIME &gt;= #{startTime} AND OPERATION_TIME &lt;= #{endTime}
        ORDER BY OPERATION_TIME DESC
    </select>

    <!-- 查询所有历史记录 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        ORDER BY OPERATION_TIME DESC
    </select>

    <!-- 根据历史记录ID查询 -->
    <select id="selectByHistoryId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        WHERE HISTORY_ID = #{historyId}
    </select>

    <!-- 分页查询历史记录 -->
    <select id="getPage" resultMap="BaseResultMap" parameterType="com.jiuxi.admin.core.bean.query.TpMenuHistoryQuery">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        <where>
            <if test="query.menuId != null and query.menuId != ''">
                AND MENU_ID = #{query.menuId}
            </if>
            <if test="query.operationType != null and query.operationType != ''">
                AND OPERATION_TYPE = #{query.operationType}
            </if>
            <if test="query.operatorId != null and query.operatorId != ''">
                AND OPERATOR_ID = #{query.operatorId}
            </if>
            <if test="query.operatorName != null and query.operatorName != ''">
                AND OPERATOR_NAME LIKE CONCAT('%', #{query.operatorName}, '%')
            </if>
             
        </where>
        ORDER BY OPERATION_TIME DESC
    </select>

    <!-- 保存历史记录 -->
    <insert id="save" parameterType="com.jiuxi.admin.core.bean.entity.TpMenuHistory">
        INSERT INTO tp_menu_history (
            HISTORY_ID, MENU_ID, MENU_NAME, OPERATION_TYPE, NODE_DATA_BEFORE, NODE_DATA_AFTER,
            FULL_TREE_BEFORE, FULL_TREE_AFTER, OPERATOR_ID, OPERATOR_NAME, OPERATION_TIME,
            CREATE_TIME, CREATOR, UPDATE_TIME, UPDATOR
        ) VALUES (
            #{historyId}, #{menuId}, #{menuName}, #{operationType}, #{nodeDataBefore}, #{nodeDataAfter},
            #{fullTreeBefore}, #{fullTreeAfter}, #{operatorId}, #{operatorName}, #{operationTime},
            #{createTime}, #{creator}, #{updateTime}, #{updator}
        )
    </insert>

    <!-- 根据ID查询详情 -->
    <select id="selectById" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tp_menu_history
        WHERE HISTORY_ID = #{historyId}
    </select>

</mapper>