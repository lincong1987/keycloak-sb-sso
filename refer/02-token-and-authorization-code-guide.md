# 令牌和授权码详解指南

## 概述

在 OAuth2 和 Keycloak SSO 系统中，**授权码**和**令牌**是两个核心概念，它们在认证流程中扮演不同的角色。本文档详细解释这两个概念的含义、特点和作用。

## 1. 授权码 (Authorization Code)

### 定义
授权码是一个临时的、一次性使用的代码，用于证明用户已经同意授权。

### 特点
- **临时性：** 通常只有 10 分钟的有效期
- **一次性：** 使用后立即失效，不能重复使用
- **不包含用户信息：** 只是一个随机字符串，本身不携带任何用户数据
- **安全传输：** 通过浏览器重定向传递，相对安全

### 作用流程
```
用户登录成功 → Keycloak 生成授权码 → 重定向回应用 → 应用获得授权码
```

### 示例
```
http://localhost:8081/system-a/login/oauth2/code/keycloak?code=abc123def456&state=xyz
```
其中 `abc123def456` 就是授权码。

## 2. 令牌 (Token)

令牌分为两种主要类型：

### 2.1 访问令牌 (Access Token)

#### 定义
访问令牌是用于访问受保护资源的凭证。

#### 特点
- **较长有效期：** 通常 15-30 分钟
- **包含权限信息：** 包含用户的权限范围 (scope)
- **JWT 格式：** 通常是 JSON Web Token，包含用户基本信息
- **可重复使用：** 在有效期内可以多次使用

#### 作用流程
```
应用使用授权码 → 向 Keycloak 换取访问令牌 → 使用令牌访问用户信息
```

### 2.2 刷新令牌 (Refresh Token)

#### 定义
刷新令牌用于获取新的访问令牌，无需用户重新登录。

#### 特点
- **长期有效：** 可能几小时到几天
- **用于续期：** 当访问令牌过期时，用刷新令牌获取新的访问令牌
- **更安全：** 通常只在后端使用，不暴露给前端

## 3. 完整的认证流程

```
1. 用户访问 system-a 受保护页面
   ↓
2. system-a 重定向到 Keycloak 登录页面
   ↓
3. 用户在 Keycloak 输入用户名密码
   ↓
4. Keycloak 验证成功，生成【授权码】
   ↓
5. Keycloak 重定向回 system-a，携带【授权码】
   ↓
6. system-a 后台用【授权码】向 Keycloak 换取【访问令牌】
   ↓
7. system-a 使用【访问令牌】从 Keycloak 获取用户信息
   ↓
8. system-a 建立用户会话，用户成功登录
```

## 4. 安全性考虑

### 为什么需要两步？
- **授权码：** 通过浏览器传输，可能被拦截，但无法直接使用
- **令牌交换：** 在后端进行，更安全，且需要客户端密钥验证
- **分离职责：** 授权码证明用户同意，令牌证明应用身份

### 安全优势
1. **防止令牌泄露：** 令牌不通过浏览器传输
2. **客户端验证：** 需要客户端密钥才能换取令牌
3. **时效性控制：** 不同类型的凭证有不同的有效期
4. **权限隔离：** 授权码和令牌承担不同的安全职责

## 5. 在项目中的配置

在 `system-a/src/main/resources/application.yml` 中：

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          keycloak:
            authorization-grant-type: authorization_code  # 使用授权码模式
            redirect-uri: http://localhost:8081/system-a/login/oauth2/code/keycloak  # 授权码回调地址
            scope: openid,profile,email  # 请求的权限范围
        provider:
          keycloak:
            issuer-uri: http://localhost:8080/realms/demo  # Keycloak realm 地址
```

这样配置告诉 Spring Security 使用授权码流程与 Keycloak 进行认证交互。

## 6. 实际应用场景

### 场景1：用户首次登录
1. 用户点击"登录"按钮
2. 应用重定向到 Keycloak
3. 用户输入凭据
4. Keycloak 返回授权码
5. 应用用授权码换取令牌
6. 应用使用令牌获取用户信息
7. 建立用户会话

### 场景2：令牌过期续期
1. 访问令牌过期
2. 应用检测到令牌失效
3. 使用刷新令牌获取新的访问令牌
4. 继续正常访问（用户无感知）

### 场景3：跨系统访问
1. 用户在 system-a 已登录
2. 访问 system-b
3. system-b 检查 Keycloak 会话
4. 发现用户已认证，直接授权访问
5. 实现单点登录效果

## 7. 常见问题

### Q: 为什么不直接返回令牌？
A: 出于安全考虑，令牌包含敏感信息，通过授权码的中间步骤可以确保令牌只在后端安全环境中传输。

### Q: 授权码可以重复使用吗？
A: 不可以。授权码是一次性的，使用后立即失效，这是 OAuth2 规范的安全要求。

### Q: 令牌丢失了怎么办？
A: 访问令牌有时效性，过期后会自动失效。如果担心泄露，可以通过 Keycloak 管理界面撤销用户会话。

## 总结

**授权码**是临时的"通行证"，**令牌**是真正的"身份证"。

- 授权码用于安全地获取令牌
- 令牌用于实际的资源访问
- 两者配合实现了安全、高效的单点登录机制

这种设计既保证了安全性，又提供了良好的用户体验，是现代 Web 应用认证的标准做法。