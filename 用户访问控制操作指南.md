# 用户访问控制操作指南

## 功能概述

用户访问控制功能允许管理员配置系统的用户访问策略，包括启用/禁用访问控制、设置拒绝访问消息以及定义具体的访问规则。

## 访问路径

- **前端页面**: 系统管理 → 用户访问控制
- **后端API**: `/api/user-access-control`

## 功能配置

### 1. 启用用户访问控制

在用户访问控制配置页面中：

1. 勾选「启用用户访问控制」复选框
2. 点击「保存」按钮应用配置

### 2. 配置拒绝访问消息

当用户被拒绝访问时显示的提示信息：

1. 在「拒绝访问消息」文本框中输入自定义消息
2. 建议消息内容简洁明了，告知用户联系管理员
3. 点击「保存」按钮保存配置

### 3. 配置访问规则

在「访问规则」文本域中定义具体的访问控制规则：

#### 规则格式示例：

```
# 允许特定用户访问
allow user:admin
allow user:manager

# 允许特定角色访问
allow role:ADMIN
allow role:USER_MANAGER

# 拒绝特定用户访问
deny user:guest

# 允许特定部门用户访问
allow dept:IT部门
allow dept:管理部门

# 时间限制访问（可选）
allow time:09:00-18:00

# 组合规则
allow user:admin AND role:ADMIN
allow (role:USER OR role:MANAGER) AND dept:IT部门
```

#### 规则语法说明：

- `allow`: 允许访问
- `deny`: 拒绝访问
- `user:用户名`: 指定用户
- `role:角色名`: 指定角色
- `dept:部门名`: 指定部门
- `time:时间范围`: 指定时间段（格式：HH:mm-HH:mm）
- `AND`: 逻辑与
- `OR`: 逻辑或
- `()`: 分组
- `#`: 注释行

## API接口说明

### 获取配置

```http
GET /api/user-access-control/config
```

**响应示例：**
```json
{
  "enabled": true,
  "denyMessage": "访问被拒绝，请联系系统管理员",
  "rules": "allow role:ADMIN\nallow user:manager"
}
```

### 更新配置

```http
PUT /api/user-access-control/config
Content-Type: application/json

{
  "enabled": true,
  "denyMessage": "访问被拒绝，请联系系统管理员",
  "rules": "allow role:ADMIN\nallow user:manager"
}
```

### 检查访问权限

```http
GET /api/user-access-control/check
```

**响应示例：**
```json
{
  "allowed": true,
  "message": "访问允许"
}
```

## 配置建议

### 1. 安全配置

- 始终为管理员角色配置访问权限
- 定期审查和更新访问规则
- 设置合适的拒绝访问消息

### 2. 规则优先级

- `deny` 规则优先级高于 `allow` 规则
- 具体用户规则优先级高于角色规则
- 规则按从上到下的顺序进行匹配

### 3. 测试建议

- 配置完成后使用不同角色的用户进行测试
- 验证拒绝访问消息是否正确显示
- 确认时间限制规则在指定时间段外生效

## 故障排除

### 常见问题

1. **配置保存失败**
   - 检查规则语法是否正确
   - 确认用户具有管理员权限
   - 查看后端日志获取详细错误信息

2. **访问控制不生效**
   - 确认「启用用户访问控制」已勾选
   - 检查规则配置是否正确
   - 验证用户角色和部门信息

3. **规则匹配异常**
   - 检查规则语法格式
   - 确认用户名、角色名、部门名拼写正确
   - 注意大小写敏感性

### 日志查看

后端日志位置：`ps-be/logs/`

关键日志关键词：
- `UserAccessControl`
- `access denied`
- `access allowed`

## 系统配置

相关系统配置键：

- `user.access.control.enabled`: 是否启用用户访问控制
- `user.access.control.deny.message`: 拒绝访问消息
- `user.access.control.rules`: 访问控制规则

## 更新记录

- 2024-01-XX: 从权限控制(PermissionControl)重命名为用户访问控制(UserAccessControl)
- 2024-01-XX: 更新API路径和配置键名
- 2024-01-XX: 统一前后端组件命名规范

---

**注意**: 修改用户访问控制配置可能影响系统正常使用，请谨慎操作并做好备份。