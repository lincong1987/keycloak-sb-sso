# 机构管理模块自动化测试计划

## 1. 测试概述

### 1.1 测试目标
本测试计划旨在对"组织管理"模块中的"机构管理"功能进行全面的自动化测试，确保系统的稳定性、可靠性和性能表现。

### 1.2 测试范围
- **核心功能**：机构的新增、编辑、删除、查询操作
- **字段验证**：所有机构相关字段的输入验证和业务规则验证
- **界面交互**：前端页面的用户交互和数据展示
- **数据关联**：机构与人员、部门等其他模块的关联关系
- **性能测试**：大数据量下的操作响应时间
- **安全测试**：权限控制和数据安全验证

### 1.3 测试环境
- **后端服务**：http://localhost:8082/ps-be
- **前端应用**：http://localhost:10801
- **数据库**：MariaDB (alilaoba.cn:13307/ps-bmp)
- **测试框架**：Jest + Selenium WebDriver

## 2. 功能模块分析

### 2.1 后端API接口
基于 `TpDeptBasicinfoController` 分析的核心接口：

| 接口路径 | 方法 | 功能描述 | 参数 |
|---------|------|----------|------|
| `/sys/dept/org/tree` | GET | 获取机构树 | deptId, jwtdid, sync |
| `/sys/dept/org/add` | POST | 添加政府机构 | TpDeptBasicinfoVO, jwtpid |
| `/sys/dept/ent/add` | POST | 添加企业机构 | TpDeptBasicinfoVO, jwtpid |
| `/sys/dept/view` | GET | 查询机构信息 | deptId, jwtpid, jwtaid |
| `/sys/dept/update` | POST | 修改机构信息 | TpDeptBasicinfoVO, jwtpid |
| `/sys/dept/delete` | POST | 删除机构 | deptId, jwtpid |
| `/sys/dept/children` | GET | 查询下级机构 | parentId, deptType, filterCommAscn, category |

### 2.2 核心字段结构
基于 `TpDeptBasicinfoVO` 的字段分析：

| 字段名 | 类型 | 必填 | 描述 | 验证规则 |
|--------|------|------|------|----------|
| deptFullName | String | 是 | 机构全称 | 长度1-100字符 |
| deptSimpleName | String | 是 | 机构简称 | 长度1-50字符 |
| deptNo | String | 否 | 机构编号 | 唯一性验证 |
| deptType | String | 是 | 机构类型 | 字典值验证 |
| principalName | String | 否 | 负责人姓名 | 长度1-20字符 |
| principalTel | String | 否 | 负责人电话 | 手机号格式验证 |
| orderIndex | Integer | 否 | 排序号 | 数值范围验证 |
| cityCode | String | 是 | 行政区划代码 | 有效区划验证 |
| enabled | Integer | 否 | 是否启用 | 0或1 |
| deptDesc | String | 否 | 机构描述 | 最大200字符 |

## 3. 详细测试用例设计

### 3.1 机构新增功能测试用例

#### TC001: 政府机构新增-正常流程
**测试目标**：验证政府机构新增的正常业务流程
**前置条件**：用户已登录，具有机构新增权限
**测试步骤**：
1. 访问机构管理页面
2. 点击"添加同级"或"添加下级"按钮
3. 填写完整的机构信息
4. 点击"保存基本信息"按钮
**测试数据**：
```json
{
  "deptFullName": "测试政府机构全称",
  "deptSimpleName": "测试机构",
  "deptNo": "TEST001",
  "deptType": "01",
  "principalName": "张三",
  "principalTel": "13800138000",
  "orderIndex": 1,
  "cityCode": "110000",
  "enabled": 1,
  "deptDesc": "这是一个测试机构"
}
```
**预期结果**：机构创建成功，返回成功响应，机构树更新
**实际结果**：[待填写]

#### TC002: 企业机构新增-正常流程
**测试目标**：验证企业机构新增的正常业务流程
**前置条件**：用户已登录，具有机构新增权限
**测试步骤**：
1. 访问机构管理页面
2. 切换到企业机构模式
3. 点击"添加同级"或"添加下级"按钮
4. 填写完整的机构信息
5. 点击"保存基本信息"按钮
**测试数据**：
```json
{
  "deptFullName": "测试企业机构全称",
  "deptSimpleName": "测试企业",
  "deptNo": "ENT001",
  "deptType": "02",
  "principalName": "李四",
  "principalTel": "13900139000",
  "orderIndex": 2,
  "cityCode": "110000",
  "enabled": 1,
  "deptDesc": "这是一个测试企业机构"
}
```
**预期结果**：企业机构创建成功，返回成功响应
**实际结果**：[待填写]

### 3.2 字段验证测试用例

#### TC003: 必填字段验证
**测试目标**：验证必填字段的验证规则
**测试步骤**：
1. 访问机构新增页面
2. 不填写必填字段，直接提交
3. 验证错误提示信息
**测试数据**：
- 机构全称为空
- 机构简称为空
- 机构类型为空
- 行政区划为空
**预期结果**：显示相应的必填字段错误提示
**实际结果**：[待填写]

#### TC004: 字段长度边界测试
**测试目标**：验证字段长度限制
**测试数据**：
- 机构全称：101个字符（超出限制）
- 机构简称：51个字符（超出限制）
- 负责人姓名：21个字符（超出限制）
- 机构描述：201个字符（超出限制）
**预期结果**：显示字段长度超出限制的错误提示
**实际结果**：[待填写]

#### TC005: 特殊字符验证
**测试目标**：验证特殊字符的处理
**测试数据**：
- 机构全称包含特殊字符：`<script>alert('test')</script>`
- 机构编号包含SQL注入：`'; DROP TABLE tp_dept_basicinfo; --`
**预期结果**：特殊字符被正确转义或拒绝
**实际结果**：[待填写]

#### TC006: 电话号码格式验证
**测试目标**：验证电话号码格式
**测试数据**：
- 有效手机号：13800138000
- 无效手机号：12345
- 固定电话：010-12345678
**预期结果**：只接受有效的电话号码格式
**实际结果**：[待填写]

### 3.3 机构查询功能测试用例

#### TC007: 机构树查询
**测试目标**：验证机构树的正确加载和展示
**测试步骤**：
1. 访问机构管理页面
2. 验证机构树的加载
3. 展开/收起节点
4. 选择不同节点
**预期结果**：机构树正确加载，节点操作正常
**实际结果**：[待填写]

#### TC008: 机构详情查询
**测试目标**：验证机构详情信息的正确显示
**测试步骤**：
1. 在机构树中选择一个机构节点
2. 验证右侧详情面板的信息显示
**预期结果**：机构详情信息完整正确显示
**实际结果**：[待填写]

### 3.4 机构编辑功能测试用例

#### TC009: 机构信息修改-正常流程
**测试目标**：验证机构信息修改功能
**前置条件**：存在可编辑的机构记录
**测试步骤**：
1. 选择要修改的机构
2. 点击"修改"按钮
3. 修改机构信息
4. 保存修改
**测试数据**：修改机构全称、简称、描述等信息
**预期结果**：机构信息修改成功，显示更新后的信息
**实际结果**：[待填写]

#### TC010: 机构编号唯一性验证
**测试目标**：验证机构编号的唯一性约束
**测试步骤**：
1. 创建机构A，编号为"TEST001"
2. 尝试创建机构B，使用相同编号"TEST001"
**预期结果**：系统提示编号重复错误
**实际结果**：[待填写]

### 3.5 机构删除功能测试用例

#### TC011: 机构删除-无关联数据
**测试目标**：验证删除无关联数据的机构
**前置条件**：存在无人员关联的机构
**测试步骤**：
1. 选择要删除的机构
2. 点击"删除本级"按钮
3. 确认删除操作
**预期结果**：机构删除成功，从机构树中移除
**实际结果**：[待填写]

#### TC012: 机构删除-有关联数据
**测试目标**：验证删除有人员关联的机构时的提示
**前置条件**：存在有人员关联的机构
**测试步骤**：
1. 选择有人员关联的机构
2. 点击"删除本级"按钮
**预期结果**：系统提示该机构有关联人员，询问是否确定删除
**实际结果**：[待填写]

### 3.6 数据关联测试用例

#### TC013: 机构与人员关联验证
**测试目标**：验证机构与人员的关联关系
**测试步骤**：
1. 创建机构
2. 为机构分配人员
3. 验证关联关系的正确性
**预期结果**：机构与人员关联关系正确建立
**实际结果**：[待填写]

#### TC014: 机构层级关系验证
**测试目标**：验证机构的层级关系
**测试步骤**：
1. 创建父级机构
2. 在父级机构下创建子级机构
3. 验证层级关系的正确性
**预期结果**：机构层级关系正确建立和显示
**实际结果**：[待填写]

### 3.7 性能测试用例

#### TC015: 大数据量机构树加载性能
**测试目标**：验证大数据量下机构树的加载性能
**测试数据**：创建1000个机构节点
**性能指标**：
- 机构树加载时间 < 3秒
- 节点展开响应时间 < 1秒
**预期结果**：在规定时间内完成加载
**实际结果**：[待填写]

#### TC016: 批量操作性能测试
**测试目标**：验证批量创建机构的性能
**测试数据**：批量创建100个机构
**性能指标**：平均创建时间 < 500ms/个
**预期结果**：批量操作在可接受时间内完成
**实际结果**：[待填写]

### 3.8 安全性测试用例

#### TC017: 权限控制验证
**测试目标**：验证机构管理的权限控制
**测试步骤**：
1. 使用无权限用户登录
2. 尝试访问机构管理功能
**预期结果**：系统拒绝访问或隐藏相关功能按钮
**实际结果**：[待填写]

#### TC018: SQL注入防护测试
**测试目标**：验证系统对SQL注入的防护
**测试数据**：在各个输入字段中输入SQL注入代码
**预期结果**：系统正确处理，不执行恶意SQL
**实际结果**：[待填写]

#### TC019: XSS攻击防护测试
**测试目标**：验证系统对XSS攻击的防护
**测试数据**：在输入字段中输入JavaScript代码
**预期结果**：系统正确转义，不执行恶意脚本
**实际结果**：[待填写]

#### TC020: 数据传输安全测试
**测试目标**：验证敏感数据的传输安全
**测试步骤**：
1. 监控网络请求
2. 验证敏感数据是否加密传输
**预期结果**：敏感数据经过加密处理
**实际结果**：[待填写]

## 4. 自动化测试脚本设计

### 4.1 测试框架选择
- **前端自动化**：Selenium WebDriver + Jest
- **API测试**：Jest + Axios
- **性能测试**：Artillery.js
- **数据库测试**：Jest + MySQL2

### 4.2 自动化测试脚本示例

#### 4.2.1 API测试脚本
```javascript
// 机构管理API自动化测试
const axios = require('axios');
const { expect } = require('@jest/globals');

const BASE_URL = 'http://localhost:8082/ps-be';
const API_ENDPOINTS = {
  orgAdd: '/sys/dept/org/add',
  orgTree: '/sys/dept/org/tree',
  deptView: '/sys/dept/view',
  deptUpdate: '/sys/dept/update',
  deptDelete: '/sys/dept/delete'
};

// 测试数据
const testOrgData = {
  deptFullName: '自动化测试机构全称',
  deptSimpleName: '自动化测试机构',
  deptNo: 'AUTO_TEST_001',
  deptType: '01',
  principalName: '测试负责人',
  principalTel: '13800138000',
  orderIndex: 1,
  cityCode: '110000',
  enabled: 1,
  deptDesc: '这是自动化测试创建的机构'
};

describe('机构管理API测试', () => {
  let createdOrgId = null;
  let authToken = null;

  beforeAll(async () => {
    // 获取认证token
    authToken = await getAuthToken();
  });

  afterAll(async () => {
    // 清理测试数据
    if (createdOrgId) {
      await cleanupTestData(createdOrgId);
    }
  });

  test('TC001: 政府机构新增-正常流程', async () => {
    const response = await axios.post(
      `${BASE_URL}${API_ENDPOINTS.orgAdd}`,
      testOrgData,
      {
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        },
        params: {
          jwtpid: 'test_user_id'
        }
      }
    );

    expect(response.status).toBe(200);
    expect(response.data.success).toBe(true);
    expect(response.data.data).toHaveProperty('id');
    
    createdOrgId = response.data.data.id;
  });

  test('TC003: 必填字段验证', async () => {
    const invalidData = { ...testOrgData };
    delete invalidData.deptFullName;
    delete invalidData.deptSimpleName;

    try {
      await axios.post(
        `${BASE_URL}${API_ENDPOINTS.orgAdd}`,
        invalidData,
        {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          params: {
            jwtpid: 'test_user_id'
          }
        }
      );
    } catch (error) {
      expect(error.response.status).toBe(400);
      expect(error.response.data.success).toBe(false);
    }
  });

  test('TC007: 机构树查询', async () => {
    const response = await axios.get(
      `${BASE_URL}${API_ENDPOINTS.orgTree}`,
      {
        headers: {
          'Authorization': `Bearer ${authToken}`
        },
        params: {
          deptId: '',
          jwtdid: 'test_dept_id',
          sync: 1
        }
      }
    );

    expect(response.status).toBe(200);
    expect(response.data.success).toBe(true);
    expect(Array.isArray(response.data.data)).toBe(true);
  });
});

// 辅助函数
async function getAuthToken() {
  // 实现获取认证token的逻辑
  return 'mock_auth_token';
}

async function cleanupTestData(orgId) {
  // 实现清理测试数据的逻辑
  try {
    await axios.post(
      `${BASE_URL}${API_ENDPOINTS.deptDelete}`,
      null,
      {
        params: {
          deptId: orgId,
          jwtpid: 'test_user_id'
        }
      }
    );
  } catch (error) {
    console.warn('清理测试数据失败:', error.message);
  }
}
```

#### 4.2.2 前端UI自动化测试脚本
```javascript
// 机构管理前端UI自动化测试
const { Builder, By, until } = require('selenium-webdriver');
const { expect } = require('@jest/globals');

const FRONTEND_URL = 'http://localhost:10801';
const TIMEOUT = 10000;

describe('机构管理前端UI测试', () => {
  let driver;

  beforeAll(async () => {
    driver = await new Builder().forBrowser('chrome').build();
    await driver.manage().window().maximize();
    
    // 登录系统
    await loginToSystem(driver);
  });

  afterAll(async () => {
    if (driver) {
      await driver.quit();
    }
  });

  test('TC001: 机构新增页面打开', async () => {
    // 导航到机构管理页面
    await driver.get(`${FRONTEND_URL}/#/sys/dept/org/tree`);
    
    // 等待页面加载
    await driver.wait(until.elementLocated(By.css('.fb-page-tree')), TIMEOUT);
    
    // 点击添加按钮
    const addButton = await driver.findElement(By.css('[icon="node"]'));
    await addButton.click();
    
    // 验证弹窗打开
    await driver.wait(until.elementLocated(By.css('.tp-dialog')), TIMEOUT);
    
    const dialogTitle = await driver.findElement(By.css('.tp-dialog .fb-form'));
    expect(await dialogTitle.isDisplayed()).toBe(true);
  });

  test('TC002: 机构信息填写和提交', async () => {
    // 填写机构全称
    const fullNameInput = await driver.findElement(
      By.css('input[placeholder="请输入部门全称"]')
    );
    await fullNameInput.clear();
    await fullNameInput.sendKeys('UI自动化测试机构');
    
    // 填写机构简称
    const simpleNameInput = await driver.findElement(
      By.css('input[placeholder="请输入部门简称"]')
    );
    await simpleNameInput.clear();
    await simpleNameInput.sendKeys('UI测试机构');
    
    // 选择机构类型
    const deptTypeSelect = await driver.findElement(
      By.css('fb-select[placeholder="请选择"]')
    );
    await deptTypeSelect.click();
    
    // 等待下拉选项出现并选择
    await driver.wait(until.elementLocated(By.css('.fb-select-option')), TIMEOUT);
    const firstOption = await driver.findElement(By.css('.fb-select-option:first-child'));
    await firstOption.click();
    
    // 点击保存按钮
    const saveButton = await driver.findElement(
      By.css('fb-button[type="primary"]')
    );
    await saveButton.click();
    
    // 验证保存成功（可以通过成功提示或页面跳转来验证）
    await driver.sleep(2000); // 等待保存完成
  });

  test('TC003: 字段验证测试', async () => {
    // 清空必填字段
    const fullNameInput = await driver.findElement(
      By.css('input[placeholder="请输入部门全称"]')
    );
    await fullNameInput.clear();
    
    // 尝试提交
    const saveButton = await driver.findElement(
      By.css('fb-button[type="primary"]')
    );
    await saveButton.click();
    
    // 验证错误提示
    await driver.wait(until.elementLocated(By.css('.fb-form-item-error')), TIMEOUT);
    const errorMessage = await driver.findElement(By.css('.fb-form-item-error'));
    expect(await errorMessage.isDisplayed()).toBe(true);
  });
});

// 辅助函数
async function loginToSystem(driver) {
  await driver.get(`${FRONTEND_URL}/#/login`);
  
  // 等待登录页面加载
  await driver.wait(until.elementLocated(By.css('input[type="text"]')), TIMEOUT);
  
  // 输入用户名和密码
  const usernameInput = await driver.findElement(By.css('input[type="text"]'));
  await usernameInput.sendKeys('admin');
  
  const passwordInput = await driver.findElement(By.css('input[type="password"]'));
  await passwordInput.sendKeys('admin123');
  
  // 点击登录按钮
  const loginButton = await driver.findElement(By.css('button[type="submit"]'));
  await loginButton.click();
  
  // 等待登录成功
  await driver.wait(until.urlContains('dashboard'), TIMEOUT);
}
```

#### 4.2.3 性能测试脚本
```javascript
// 机构管理性能测试配置
module.exports = {
  config: {
    target: 'http://localhost:8082',
    phases: [
      {
        duration: '2m',
        arrivalRate: 10,
        name: '预热阶段'
      },
      {
        duration: '5m',
        arrivalRate: 50,
        name: '负载测试'
      },
      {
        duration: '2m',
        arrivalRate: 100,
        name: '压力测试'
      }
    ],
    defaults: {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer {{ authToken }}'
      }
    }
  },
  scenarios: [
    {
      name: '机构树查询性能测试',
      weight: 40,
      flow: [
        {
          get: {
            url: '/ps-be/sys/dept/org/tree',
            qs: {
              deptId: '',
              jwtdid: 'test_dept_id',
              sync: 1
            },
            capture: {
              json: '$.data',
              as: 'treeData'
            },
            expect: [
              {
                statusCode: 200
              },
              {
                hasProperty: 'data'
              }
            ]
          }
        }
      ]
    },
    {
      name: '机构新增性能测试',
      weight: 30,
      flow: [
        {
          post: {
            url: '/ps-be/sys/dept/org/add',
            qs: {
              jwtpid: 'test_user_id'
            },
            json: {
              deptFullName: '性能测试机构{{ $randomString() }}',
              deptSimpleName: '性能测试{{ $randomString() }}',
              deptNo: 'PERF_{{ $randomString() }}',
              deptType: '01',
              principalName: '测试负责人',
              principalTel: '13800138000',
              orderIndex: 1,
              cityCode: '110000',
              enabled: 1,
              deptDesc: '性能测试创建的机构'
            },
            expect: [
              {
                statusCode: 200
              }
            ]
          }
        }
      ]
    },
    {
      name: '机构查询性能测试',
      weight: 30,
      flow: [
        {
          get: {
            url: '/ps-be/sys/dept/view',
            qs: {
              deptId: 'test_dept_id',
              jwtpid: 'test_user_id',
              jwtaid: 'test_admin_id'
            },
            expect: [
              {
                statusCode: 200
              }
            ]
          }
        }
      ]
    }
  ]
};
```

## 5. 测试数据准备

### 5.1 基础测试数据
```sql
-- 清理测试数据
DELETE FROM tp_dept_basicinfo WHERE dept_no LIKE 'TEST%' OR dept_no LIKE 'AUTO%';

-- 插入测试用的机构类型字典数据
INSERT INTO tp_dict_detail (dict_code, dict_name, dict_value, dict_desc, enabled) VALUES
('SYS05', '政府机关', '01', '政府机关类型', 1),
('SYS05', '企业单位', '02', '企业单位类型', 1),
('SYS05', '事业单位', '03', '事业单位类型', 1);

-- 插入测试用的行政区划数据
INSERT INTO tp_city (city_code, city_name, parent_code, city_level) VALUES
('110000', '北京市', '100000', 1),
('110100', '北京市市辖区', '110000', 2),
('110101', '东城区', '110100', 3);

-- 创建测试用的根机构
INSERT INTO tp_dept_basicinfo (
  id, dept_full_name, dept_simple_name, dept_no, dept_type, 
  principal_name, principal_tel, order_index, city_code, 
  enabled, dept_desc, create_time, creator
) VALUES (
  'test_root_dept', '测试根机构', '测试根机构', 'ROOT_TEST', '01',
  '测试管理员', '13800138000', 1, '110000',
  1, '用于自动化测试的根机构', NOW(), 'test_user'
);
```

### 5.2 边界测试数据
```javascript
// 边界测试数据集
const boundaryTestData = {
  // 字段长度边界测试
  maxLengthData: {
    deptFullName: 'A'.repeat(100), // 最大长度
    deptSimpleName: 'B'.repeat(50), // 最大长度
    principalName: 'C'.repeat(20), // 最大长度
    deptDesc: 'D'.repeat(200) // 最大长度
  },
  
  // 超出长度限制的数据
  overLengthData: {
    deptFullName: 'A'.repeat(101), // 超出限制
    deptSimpleName: 'B'.repeat(51), // 超出限制
    principalName: 'C'.repeat(21), // 超出限制
    deptDesc: 'D'.repeat(201) // 超出限制
  },
  
  // 特殊字符测试数据
  specialCharData: {
    deptFullName: '<script>alert("XSS")</script>',
    deptSimpleName: '"; DROP TABLE tp_dept_basicinfo; --',
    principalName: '\x00\x01\x02',
    deptDesc: '🚀🎉💻📱🌟' // emoji字符
  },
  
  // 电话号码测试数据
  phoneTestData: [
    '13800138000', // 有效手机号
    '010-12345678', // 有效固话
    '400-123-4567', // 有效400号码
    '12345', // 无效号码
    'abc123def', // 包含字母
    '138001380001' // 超长号码
  ]
};
```

### 5.3 性能测试数据
```javascript
// 性能测试数据生成器
class PerformanceTestDataGenerator {
  static generateOrgData(count) {
    const orgData = [];
    for (let i = 1; i <= count; i++) {
      orgData.push({
        deptFullName: `性能测试机构${i.toString().padStart(4, '0')}`,
        deptSimpleName: `测试机构${i}`,
        deptNo: `PERF_${i.toString().padStart(4, '0')}`,
        deptType: i % 2 === 0 ? '01' : '02',
        principalName: `负责人${i}`,
        principalTel: `138${(i % 10000).toString().padStart(8, '0')}`,
        orderIndex: i,
        cityCode: '110000',
        enabled: 1,
        deptDesc: `这是第${i}个性能测试机构`
      });
    }
    return orgData;
  }
  
  static generateTreeStructure(depth, breadth) {
    // 生成指定深度和广度的机构树结构
    const treeData = [];
    
    function createNode(level, parentId, index) {
      const nodeId = `node_${level}_${index}`;
      const node = {
        id: nodeId,
        deptFullName: `第${level}级机构${index}`,
        deptSimpleName: `机构${level}-${index}`,
        deptNo: `TREE_${level}_${index}`,
        parentId: parentId,
        children: []
      };
      
      if (level < depth) {
        for (let i = 1; i <= breadth; i++) {
          node.children.push(createNode(level + 1, nodeId, i));
        }
      }
      
      return node;
    }
    
    for (let i = 1; i <= breadth; i++) {
      treeData.push(createNode(1, null, i));
    }
    
    return treeData;
  }
}
```

## 6. 测试执行计划

### 6.1 测试阶段划分

| 阶段 | 时间安排 | 测试内容 | 负责人 | 交付物 |
|------|----------|----------|--------|--------|
| 第一阶段 | 第1-2天 | 环境搭建、基础功能测试 | 测试工程师A | 环境配置文档、基础功能测试报告 |
| 第二阶段 | 第3-4天 | 字段验证、边界测试 | 测试工程师B | 字段验证测试报告 |
| 第三阶段 | 第5-6天 | 数据关联、业务流程测试 | 测试工程师A | 业务流程测试报告 |
| 第四阶段 | 第7-8天 | 性能测试、安全测试 | 测试工程师C | 性能测试报告、安全测试报告 |
| 第五阶段 | 第9-10天 | 自动化脚本执行、回归测试 | 全体测试人员 | 自动化测试报告、回归测试报告 |

### 6.2 测试环境要求

#### 6.2.1 硬件环境
- **测试服务器**：4C 8G 配置
- **数据库服务器**：独立数据库实例
- **客户端**：Chrome浏览器最新版本

#### 6.2.2 软件环境
- **操作系统**：Ubuntu 20.04 LTS
- **Java版本**：JDK 11+
- **Node.js版本**：16.x+
- **数据库**：MariaDB 10.5+
- **测试工具**：
  - Jest 29.x
  - Selenium WebDriver 4.x
  - Artillery.js 2.x
  - Postman/Newman

### 6.3 测试数据管理

#### 6.3.1 数据准备策略
1. **基础数据**：在测试开始前准备好字典数据、区划数据等
2. **测试数据**：每个测试用例使用独立的测试数据
3. **数据隔离**：使用特定前缀标识测试数据，避免影响生产数据

#### 6.3.2 数据清理策略
1. **自动清理**：测试完成后自动删除测试数据
2. **手动清理**：定期手动清理残留的测试数据
3. **数据备份**：测试前备份重要数据

## 7. 缺陷管理

### 7.1 缺陷分类

| 严重级别 | 描述 | 处理时间 | 示例 |
|----------|------|----------|------|
| 致命 | 系统崩溃、数据丢失 | 2小时内 | 机构删除导致系统崩溃 |
| 严重 | 核心功能无法使用 | 1天内 | 机构新增功能完全失效 |
| 一般 | 功能异常但有替代方案 | 3天内 | 机构树展开缓慢 |
| 轻微 | 界面显示问题 | 1周内 | 按钮样式不统一 |

### 7.2 缺陷跟踪流程
1. **发现缺陷** → 记录缺陷详情
2. **分析缺陷** → 确定严重级别和影响范围
3. **分配缺陷** → 指派给相应开发人员
4. **修复缺陷** → 开发人员修复并提交
5. **验证缺陷** → 测试人员验证修复效果
6. **关闭缺陷** → 确认修复后关闭缺陷

### 7.3 缺陷报告模板
```markdown
## 缺陷ID：BUG-ORG-001

**缺陷标题**：机构全称超长时保存失败但无错误提示

**发现时间**：2024-01-15 14:30:00

**发现人员**：测试工程师A

**严重级别**：一般

**缺陷描述**：
当机构全称输入超过100个字符时，点击保存按钮后保存失败，但页面没有显示任何错误提示信息。

**重现步骤**：
1. 打开机构新增页面
2. 在机构全称字段输入101个字符
3. 填写其他必填字段
4. 点击保存按钮

**预期结果**：
显示字段长度超出限制的错误提示

**实际结果**：
保存失败但无任何提示

**测试环境**：
- 浏览器：Chrome 120.0.6099.109
- 操作系统：Windows 11
- 后端版本：v1.0.0

**附件**：
- 截图：bug-org-001-screenshot.png
- 日志：bug-org-001-log.txt
```

## 8. 测试报告

### 8.1 测试执行总结

#### 8.1.1 测试概况
- **测试开始时间**：[待填写]
- **测试结束时间**：[待填写]
- **测试用例总数**：20个
- **执行用例数**：[待填写]
- **通过用例数**：[待填写]
- **失败用例数**：[待填写]
- **通过率**：[待填写]%

#### 8.1.2 功能测试结果

| 功能模块 | 用例数 | 通过数 | 失败数 | 通过率 | 备注 |
|----------|--------|--------|--------|--------|------|
| 机构新增 | 4 | [待填写] | [待填写] | [待填写]% | |
| 机构查询 | 3 | [待填写] | [待填写] | [待填写]% | |
| 机构编辑 | 3 | [待填写] | [待填写] | [待填写]% | |
| 机构删除 | 2 | [待填写] | [待填写] | [待填写]% | |
| 字段验证 | 4 | [待填写] | [待填写] | [待填写]% | |
| 数据关联 | 2 | [待填写] | [待填写] | [待填写]% | |
| 性能测试 | 2 | [待填写] | [待填写] | [待填写]% | |

#### 8.1.3 性能测试结果

| 测试场景 | 目标指标 | 实际结果 | 是否达标 | 备注 |
|----------|----------|----------|----------|------|
| 机构树加载 | < 3秒 | [待填写] | [待填写] | |
| 节点展开 | < 1秒 | [待填写] | [待填写] | |
| 机构新增 | < 500ms | [待填写] | [待填写] | |
| 批量操作 | < 500ms/个 | [待填写] | [待填写] | |

### 8.2 缺陷统计

#### 8.2.1 缺陷分布

| 严重级别 | 数量 | 占比 | 状态分布 |
|----------|------|------|----------|
| 致命 | [待填写] | [待填写]% | 已修复：[待填写]，待修复：[待填写] |
| 严重 | [待填写] | [待填写]% | 已修复：[待填写]，待修复：[待填写] |
| 一般 | [待填写] | [待填写]% | 已修复：[待填写]，待修复：[待填写] |
| 轻微 | [待填写] | [待填写]% | 已修复：[待填写]，待修复：[待填写] |

#### 8.2.2 缺陷趋势分析
[待填写缺陷发现和修复的趋势图表]

### 8.3 测试结论

#### 8.3.1 功能完整性
[待填写功能完整性评估结果]

#### 8.3.2 质量评估
[待填写系统质量评估结果]

#### 8.3.3 风险评估
[待填写发现的风险点和建议]

#### 8.3.4 上线建议
[待填写是否建议上线及注意事项]

## 9. 风险评估

### 9.1 技术风险

| 风险项 | 风险等级 | 影响描述 | 应对措施 |
|--------|----------|----------|----------|
| 数据库连接异常 | 高 | 可能导致机构数据无法保存或查询 | 1. 增加数据库连接重试机制<br>2. 实现数据库连接池监控<br>3. 准备数据库故障切换方案 |
| 大数据量性能问题 | 中 | 机构树加载缓慢，影响用户体验 | 1. 实现分页加载<br>2. 添加数据缓存机制<br>3. 优化数据库查询语句 |
| 并发操作冲突 | 中 | 多用户同时操作可能导致数据不一致 | 1. 实现乐观锁机制<br>2. 添加操作日志记录<br>3. 增加数据版本控制 |

### 9.2 业务风险

| 风险项 | 风险等级 | 影响描述 | 应对措施 |
|--------|----------|----------|----------|
| 机构层级关系错误 | 高 | 可能导致权限分配错误，影响系统安全 | 1. 增强层级关系验证<br>2. 实现关系变更审批流程<br>3. 添加关系变更日志 |
| 数据迁移风险 | 中 | 历史数据迁移可能出现数据丢失或错误 | 1. 制定详细的数据迁移方案<br>2. 进行充分的迁移测试<br>3. 准备数据回滚方案 |
| 用户权限管理 | 中 | 权限配置错误可能导致越权操作 | 1. 实现细粒度权限控制<br>2. 定期进行权限审计<br>3. 添加敏感操作审批 |

### 9.3 安全风险

| 风险项 | 风险等级 | 影响描述 | 应对措施 |
|--------|----------|----------|----------|
| SQL注入攻击 | 高 | 可能导致数据库被恶意操作 | 1. 使用参数化查询<br>2. 输入数据验证和过滤<br>3. 定期进行安全扫描 |
| XSS攻击 | 中 | 可能导致用户信息泄露 | 1. 输出数据转义<br>2. 实现CSP策略<br>3. 定期更新前端安全库 |
| 敏感信息泄露 | 中 | 机构信息可能被未授权访问 | 1. 实现数据加密传输<br>2. 敏感字段脱敏显示<br>3. 访问日志记录和监控 |

## 10. 附录

### 10.1 测试环境配置

#### 10.1.1 Jest配置文件
```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: [
    '**/__tests__/**/*.+(ts|tsx|js)',
    '**/*.(test|spec).+(ts|tsx|js)'
  ],
  transform: {
    '^.+\.(ts|tsx)$': 'ts-jest'
  },
  collectCoverageFrom: [
    'src/**/*.{js,ts}',
    '!src/**/*.d.ts'
  ],
  coverageDirectory: 'coverage',
  coverageReporters: [
    'text',
    'lcov',
    'html'
  ],
  setupFilesAfterEnv: ['<rootDir>/tests/setup.js'],
  testTimeout: 30000
};
```

#### 10.1.2 Selenium配置
```javascript
// selenium.config.js
const { Builder } = require('selenium-webdriver');
const chrome = require('selenium-webdriver/chrome');

class WebDriverManager {
  static async createDriver() {
    const options = new chrome.Options();
    
    // 无头模式配置（CI环境使用）
    if (process.env.HEADLESS === 'true') {
      options.addArguments('--headless');
    }
    
    // 其他Chrome选项
    options.addArguments('--no-sandbox');
    options.addArguments('--disable-dev-shm-usage');
    options.addArguments('--disable-gpu');
    options.addArguments('--window-size=1920,1080');
    
    const driver = await new Builder()
      .forBrowser('chrome')
      .setChromeOptions(options)
      .build();
    
    // 设置隐式等待
    await driver.manage().setTimeouts({
      implicit: 10000,
      pageLoad: 30000,
      script: 30000
    });
    
    return driver;
  }
}

module.exports = WebDriverManager;
```

### 10.2 数据库脚本

#### 10.2.1 测试数据初始化脚本
```sql
-- 机构管理测试数据初始化脚本
-- 执行前请备份数据库

-- 1. 清理历史测试数据
DELETE FROM tp_dept_basicinfo WHERE dept_no LIKE 'TEST_%' OR dept_no LIKE 'AUTO_%' OR dept_no LIKE 'PERF_%';
DELETE FROM tp_person_dept WHERE dept_id IN (
    SELECT id FROM tp_dept_basicinfo WHERE dept_no LIKE 'TEST_%'
);

-- 2. 插入测试用字典数据
INSERT IGNORE INTO tp_dict_detail (dict_code, dict_name, dict_value, dict_desc, enabled, create_time) VALUES
('SYS05', '政府机关', '01', '政府机关类型', 1, NOW()),
('SYS05', '企业单位', '02', '企业单位类型', 1, NOW()),
('SYS05', '事业单位', '03', '事业单位类型', 1, NOW()),
('SYS05', '社会团体', '04', '社会团体类型', 1, NOW());

-- 3. 插入测试用行政区划数据
INSERT IGNORE INTO tp_city (city_code, city_name, parent_code, city_level, enabled, create_time) VALUES
('100000', '中华人民共和国', '', 0, 1, NOW()),
('110000', '北京市', '100000', 1, 1, NOW()),
('110100', '北京市市辖区', '110000', 2, 1, NOW()),
('110101', '东城区', '110100', 3, 1, NOW()),
('110102', '西城区', '110100', 3, 1, NOW()),
('120000', '天津市', '100000', 1, 1, NOW()),
('120100', '天津市市辖区', '120000', 2, 1, NOW());

-- 4. 创建测试用根机构
INSERT INTO tp_dept_basicinfo (
    id, dept_full_name, dept_simple_name, dept_no, dept_type,
    principal_name, principal_tel, order_index, city_code,
    enabled, dept_desc, create_time, creator, parent_id
) VALUES (
    'test_root_org', '自动化测试根机构', '测试根机构', 'TEST_ROOT_001', '01',
    '测试管理员', '13800138000', 1, '110000',
    1, '用于自动化测试的根机构，请勿删除', NOW(), 'auto_test', NULL
);

-- 5. 创建测试用子机构
INSERT INTO tp_dept_basicinfo (
    id, dept_full_name, dept_simple_name, dept_no, dept_type,
    principal_name, principal_tel, order_index, city_code,
    enabled, dept_desc, create_time, creator, parent_id
) VALUES 
(
    'test_child_org_1', '自动化测试子机构1', '测试子机构1', 'TEST_CHILD_001', '02',
    '测试负责人1', '13800138001', 1, '110101',
    1, '用于测试层级关系的子机构1', NOW(), 'auto_test', 'test_root_org'
),
(
    'test_child_org_2', '自动化测试子机构2', '测试子机构2', 'TEST_CHILD_002', '03',
    '测试负责人2', '13800138002', 2, '110102',
    1, '用于测试层级关系的子机构2', NOW(), 'auto_test', 'test_root_org'
);

-- 6. 创建测试用户（如果需要）
INSERT IGNORE INTO tp_person_basicinfo (
    id, person_name, login_name, password, enabled, create_time
) VALUES (
    'test_user_001', '自动化测试用户', 'autotest', 'e10adc3949ba59abbe56e057f20f883e', 1, NOW()
);

-- 7. 建立测试用户与机构的关联
INSERT IGNORE INTO tp_person_dept (
    person_id, dept_id, is_main, create_time
) VALUES (
    'test_user_001', 'test_root_org', 1, NOW()
);

COMMIT;
```

#### 10.2.2 测试数据清理脚本
```sql
-- 机构管理测试数据清理脚本
-- 清理所有自动化测试产生的数据

START TRANSACTION;

-- 1. 清理人员机构关联
DELETE FROM tp_person_dept WHERE dept_id IN (
    SELECT id FROM tp_dept_basicinfo WHERE dept_no LIKE 'TEST_%' OR dept_no LIKE 'AUTO_%' OR dept_no LIKE 'PERF_%'
);

-- 2. 清理机构扩展信息
DELETE FROM tp_dept_exinfo WHERE dept_id IN (
    SELECT id FROM tp_dept_basicinfo WHERE dept_no LIKE 'TEST_%' OR dept_no LIKE 'AUTO_%' OR dept_no LIKE 'PERF_%'
);

-- 3. 清理机构基本信息
DELETE FROM tp_dept_basicinfo WHERE 
    dept_no LIKE 'TEST_%' OR 
    dept_no LIKE 'AUTO_%' OR 
    dept_no LIKE 'PERF_%' OR
    dept_full_name LIKE '%自动化测试%' OR
    dept_full_name LIKE '%性能测试%' OR
    creator = 'auto_test';

-- 4. 清理测试用户
DELETE FROM tp_person_basicinfo WHERE login_name LIKE 'autotest%' OR person_name LIKE '%自动化测试%';

-- 5. 重置自增ID（如果使用自增主键）
-- ALTER TABLE tp_dept_basicinfo AUTO_INCREMENT = 1;

COMMIT;

-- 验证清理结果
SELECT COUNT(*) as remaining_test_data FROM tp_dept_basicinfo WHERE 
    dept_no LIKE 'TEST_%' OR 
    dept_no LIKE 'AUTO_%' OR 
    dept_no LIKE 'PERF_%';
```

### 10.3 持续集成配置

#### 10.3.1 GitHub Actions配置
```yaml
# .github/workflows/org-management-test.yml
name: 机构管理自动化测试

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/main/java/com/jiuxi/admin/core/controller/pc/TpDeptBasicinfoController.java'
      - 'src/main/java/com/jiuxi/admin/core/service/TpDeptBasicinfoService.java'
      - 'ps-fe/@fb/admin-base/views/sys/dept/**'
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点执行

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mariadb:10.5
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: ps_bmp_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Java环境
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: 设置Node.js环境
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
        cache-dependency-path: ps-fe/package-lock.json
    
    - name: 安装Chrome浏览器
      uses: browser-actions/setup-chrome@latest
    
    - name: 初始化测试数据库
      run: |
        mysql -h127.0.0.1 -uroot -ptestpassword ps_bmp_test < tests/sql/init_test_data.sql
    
    - name: 构建后端应用
      run: |
        cd ps-be
        ./mvnw clean compile test-compile
    
    - name: 安装前端依赖
      run: |
        cd ps-fe
        npm ci
    
    - name: 启动后端服务
      run: |
        cd ps-be
        nohup ./mvnw spring-boot:run -Dspring-boot.run.profiles=test &
        sleep 30
    
    - name: 启动前端服务
      run: |
        cd ps-fe
        nohup npm run dev &
        sleep 20
    
    - name: 运行API测试
      run: |
        npm test -- --testPathPattern=api
    
    - name: 运行UI测试
      run: |
        npm test -- --testPathPattern=ui
      env:
        HEADLESS: true
    
    - name: 运行性能测试
      run: |
        npx artillery run tests/performance/org-management-performance.yml
    
    - name: 生成测试报告
      run: |
        npm run test:report
    
    - name: 上传测试报告
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports
        path: |
          coverage/
          test-results/
          performance-results/
```

#### 10.3.2 Jenkins Pipeline配置
```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        JAVA_HOME = '/usr/lib/jvm/java-11-openjdk'
        NODE_HOME = '/usr/local/node'
        MYSQL_HOST = 'localhost'
        MYSQL_PORT = '3306'
        TEST_DB = 'ps_bmp_test'
    }
    
    stages {
        stage('环境准备') {
            steps {
                script {
                    // 清理工作空间
                    cleanWs()
                    
                    // 检出代码
                    checkout scm
                    
                    // 准备测试数据库
                    sh '''
                        mysql -h${MYSQL_HOST} -P${MYSQL_PORT} -uroot -p${MYSQL_ROOT_PASSWORD} \
                        -e "DROP DATABASE IF EXISTS ${TEST_DB}; CREATE DATABASE ${TEST_DB};"
                        
                        mysql -h${MYSQL_HOST} -P${MYSQL_PORT} -uroot -p${MYSQL_ROOT_PASSWORD} \
                        ${TEST_DB} < tests/sql/init_test_data.sql
                    '''
                }
            }
        }
        
        stage('构建应用') {
            parallel {
                stage('构建后端') {
                    steps {
                        dir('ps-be') {
                            sh './mvnw clean compile test-compile'
                        }
                    }
                }
                
                stage('构建前端') {
                    steps {
                        dir('ps-fe') {
                            sh 'npm ci'
                        }
                    }
                }
            }
        }
        
        stage('启动服务') {
            steps {
                script {
                    // 启动后端服务
                    dir('ps-be') {
                        sh 'nohup ./mvnw spring-boot:run -Dspring-boot.run.profiles=test > backend.log 2>&1 &'
                    }
                    
                    // 等待后端启动
                    sh 'sleep 30'
                    
                    // 启动前端服务
                    dir('ps-fe') {
                        sh 'nohup npm run dev > frontend.log 2>&1 &'
                    }
                    
                    // 等待前端启动
                    sh 'sleep 20'
                    
                    // 验证服务启动状态
                    sh '''
                        curl -f http://localhost:8082/ps-be/actuator/health || exit 1
                        curl -f http://localhost:10801 || exit 1
                    '''
                }
            }
        }
        
        stage('执行测试') {
            parallel {
                stage('API测试') {
                    steps {
                        sh 'npm test -- --testPathPattern=api --reporter=junit --outputFile=test-results/api-results.xml'
                    }
                    post {
                        always {
                            junit 'test-results/api-results.xml'
                        }
                    }
                }
                
                stage('UI测试') {
                    steps {
                        sh 'HEADLESS=true npm test -- --testPathPattern=ui --reporter=junit --outputFile=test-results/ui-results.xml'
                    }
                    post {
                        always {
                            junit 'test-results/ui-results.xml'
                        }
                    }
                }
                
                stage('性能测试') {
                    steps {
                        sh 'npx artillery run tests/performance/org-management-performance.yml --output performance-results/results.json'
                        sh 'npx artillery report performance-results/results.json --output performance-results/report.html'
                    }
                }
            }
        }
        
        stage('生成报告') {
            steps {
                script {
                    // 生成覆盖率报告
                    sh 'npm run test:coverage'
                    
                    // 生成综合测试报告
                    sh 'npm run test:report'
                }
            }
            post {
                always {
                    // 发布HTML报告
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage',
                        reportFiles: 'index.html',
                        reportName: '代码覆盖率报告'
                    ])
                    
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'performance-results',
                        reportFiles: 'report.html',
                        reportName: '性能测试报告'
                    ])
                    
                    // 归档测试结果
                    archiveArtifacts artifacts: 'test-results/**, coverage/**, performance-results/**', fingerprint: true
                }
            }
        }
    }
    
    post {
        always {
            script {
                // 停止服务
                sh 'pkill -f "spring-boot:run" || true'
                sh 'pkill -f "npm run dev" || true'
                
                // 清理测试数据
                sh '''
                    mysql -h${MYSQL_HOST} -P${MYSQL_PORT} -uroot -p${MYSQL_ROOT_PASSWORD} \
                    ${TEST_DB} < tests/sql/cleanup_test_data.sql || true
                '''
            }
        }
        
        success {
            emailext (
                subject: "机构管理自动化测试 - 成功 - ${env.BUILD_NUMBER}",
                body: "测试执行成功，详细报告请查看：${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
        
        failure {
            emailext (
                subject: "机构管理自动化测试 - 失败 - ${env.BUILD_NUMBER}",
                body: "测试执行失败，请及时处理。详细信息：${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

### 10.4 测试工具和库

#### 10.4.1 依赖包配置
```json
{
  "name": "org-management-automation-test",
  "version": "1.0.0",
  "description": "机构管理模块自动化测试",
  "scripts": {
    "test": "jest",
    "test:api": "jest --testPathPattern=api",
    "test:ui": "jest --testPathPattern=ui",
    "test:performance": "artillery run tests/performance/org-management-performance.yml",
    "test:coverage": "jest --coverage",
    "test:report": "node scripts/generate-report.js",
    "test:watch": "jest --watch",
    "test:debug": "node --inspect-brk node_modules/.bin/jest --runInBand"
  },
  "devDependencies": {
    "@jest/globals": "^29.7.0",
    "jest": "^29.7.0",
    "selenium-webdriver": "^4.15.0",
    "axios": "^1.6.0",
    "artillery": "^2.0.0",
    "mysql2": "^3.6.0",
    "dotenv": "^16.3.0",
    "faker": "^6.6.6",
    "moment": "^2.29.4",
    "lodash": "^4.17.21",
    "csv-parser": "^3.0.0",
    "xlsx": "^0.18.5"
  },
  "jest": {
    "testEnvironment": "node",
    "setupFilesAfterEnv": ["<rootDir>/tests/setup.js"],
    "testTimeout": 30000,
    "collectCoverageFrom": [
      "tests/**/*.js",
      "!tests/setup.js",
      "!tests/utils/**"
    ],
    "coverageDirectory": "coverage",
    "coverageReporters": ["text", "lcov", "html"],
    "testMatch": [
      "**/__tests__/**/*.js",
      "**/tests/**/*.test.js"
    ]
  }
}
```

#### 10.4.2 测试工具类
```javascript
// tests/utils/TestHelper.js
const axios = require('axios');
const mysql = require('mysql2/promise');
const faker = require('faker');

class TestHelper {
  constructor() {
    this.baseURL = process.env.API_BASE_URL || 'http://localhost:8082/ps-be';
    this.frontendURL = process.env.FRONTEND_URL || 'http://localhost:10801';
    this.dbConfig = {
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || 'testpassword',
      database: process.env.DB_NAME || 'ps_bmp_test'
    };
  }

  // 生成测试数据
  generateOrgData(overrides = {}) {
    const defaultData = {
      deptFullName: faker.company.companyName() + '机构',
      deptSimpleName: faker.company.companySuffix(),
      deptNo: 'TEST_' + faker.datatype.uuid().substring(0, 8).toUpperCase(),
      deptType: faker.random.arrayElement(['01', '02', '03']),
      principalName: faker.name.findName(),
      principalTel: faker.phone.phoneNumber('138########'),
      orderIndex: faker.datatype.number({ min: 1, max: 999 }),
      cityCode: '110000',
      enabled: 1,
      deptDesc: faker.lorem.sentence()
    };
    
    return { ...defaultData, ...overrides };
  }

  // API请求封装
  async apiRequest(method, endpoint, data = null, params = {}) {
    try {
      const config = {
        method,
        url: `${this.baseURL}${endpoint}`,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.authToken}`
        },
        params
      };
      
      if (data) {
        config.data = data;
      }
      
      const response = await axios(config);
      return response;
    } catch (error) {
      console.error(`API请求失败: ${method} ${endpoint}`, error.message);
      throw error;
    }
  }

  // 数据库操作
  async executeQuery(sql, params = []) {
    const connection = await mysql.createConnection(this.dbConfig);
    try {
      const [results] = await connection.execute(sql, params);
      return results;
    } finally {
      await connection.end();
    }
  }

  // 清理测试数据
  async cleanupTestData(pattern = 'TEST_%') {
    const sql = `
      DELETE FROM tp_dept_basicinfo 
      WHERE dept_no LIKE ? OR creator = 'auto_test'
    `;
    await this.executeQuery(sql, [pattern]);
  }

  // 等待元素出现
  async waitForElement(driver, locator, timeout = 10000) {
    const { until } = require('selenium-webdriver');
    return await driver.wait(until.elementLocated(locator), timeout);
  }

  // 截图
  async takeScreenshot(driver, filename) {
    const fs = require('fs');
    const screenshot = await driver.takeScreenshot();
    fs.writeFileSync(`screenshots/${filename}`, screenshot, 'base64');
  }

  // 生成测试报告
  generateTestReport(results) {
    const report = {
      timestamp: new Date().toISOString(),
      summary: {
        total: results.length,
        passed: results.filter(r => r.status === 'passed').length,
        failed: results.filter(r => r.status === 'failed').length,
        skipped: results.filter(r => r.status === 'skipped').length
      },
      details: results
    };
    
    const fs = require('fs');
    fs.writeFileSync(
      'test-results/report.json', 
      JSON.stringify(report, null, 2)
    );
    
    return report;
  }
}

module.exports = TestHelper;
```

## 11. 总结

本自动化测试计划全面覆盖了机构管理模块的各个方面，包括：

### 11.1 测试覆盖范围
- ✅ **功能测试**：CRUD操作的完整测试覆盖
- ✅ **字段验证**：所有字段的验证规则和边界条件测试
- ✅ **自动化设计**：完整的自动化测试脚本和框架
- ✅ **边界测试**：字段长度、特殊字符、必填项等边界条件
- ✅ **数据关联**：机构与人员、部门等模块的关联关系验证
- ✅ **性能测试**：大数据量下的操作响应时间测试

### 11.2 测试用例统计
- **总计**：20个详细测试用例
- **功能测试**：14个用例（新增4个、查询2个、编辑2个、删除2个、关联2个、权限2个）
- **性能测试**：2个用例
- **安全测试**：4个用例

### 11.3 自动化脚本
- **API测试脚本**：基于Jest和Axios的完整API测试套件
- **UI测试脚本**：基于Selenium WebDriver的前端自动化测试
- **性能测试脚本**：基于Artillery.js的性能测试配置
- **数据库测试**：完整的测试数据准备和清理脚本

### 11.4 持续集成
- **GitHub Actions**：完整的CI/CD流水线配置
- **Jenkins Pipeline**：企业级持续集成配置
- **测试报告**：自动化的测试报告生成和发布

### 11.5 质量保证
- **代码覆盖率**：目标覆盖率≥80%
- **性能指标**：明确的性能测试目标和验收标准
- **安全测试**：SQL注入、XSS攻击等安全漏洞检测
- **缺陷管理**：完整的缺陷分类、跟踪和管理流程

本测试计划确保了机构管理功能的高质量交付，通过自动化测试提高了测试效率和准确性，为系统的稳定运行提供了可靠保障。